# PS60 Live Trader Configuration
# Based on backtest results from September 30, 2025

trading:
  account_size: 50000   # Changed from 100000 to 50000 (Oct 13, 2025)
  risk_per_trade: 0.01  # 1% risk per trade
  max_positions: 10     # Maximum concurrent positions (increased for more opportunities)
  max_daily_loss: 0.03  # 3% max daily loss (circuit breaker)

  position_sizing:
    min_shares: 10
    max_shares: 1000          # Hard cap on share count
    max_position_value: 10000 # Adaptive sizing: $10k max per position (20% of account)
    max_position_pct: 100.0   # Legacy check - replaced by max_position_value

  entry:
    use_market_orders: true
    min_entry_time: "09:45"   # Wait 15 min after open
    max_entry_time: "15:00"   # No new entries after 3:00 PM

  # Slippage and commissions (per requirements)
  slippage:
    enabled: true
    percentage: 0.001          # 0.1% slippage (configurable 0.1-0.5%)

  commissions:
    enabled: true
    per_share: 0.005           # $0.005 per share (IBKR default)

  exits:
    # ===== LEGACY 1R/2R SYSTEM (Fallback) =====
    partial_1_pct: 0.50       # Sell 50% at 1R (profit = risk)
    partial_2_pct: 0.25       # Sell 25% at target1 (2R)
    runner_pct: 0.25          # Hold 25% as runner with trailing stop
    eod_close_time: "15:55"   # Close all positions 5 min before close

    # ===== PROGRESSIVE PARTIAL SYSTEM (Oct 12, 2025) =====
    # NEW: 25% partials at SMA/target levels instead of fixed 1R/2R
    # Set to false to use legacy 1R/2R system above
    use_sma_target_partials: true     # ENABLED for testing
    partial_size: 0.25                # 25% at each level (4 exits total)
    max_partial_levels: 4             # Max exit levels to use

    # SMA Configuration (Priority 1 - real market structure)
    sma:
      enabled: true
      periods: [5, 10, 20, 50, 100]   # SMA5, SMA10, SMA20, SMA50, SMA100
      timeframe: '1 hour'             # '1 hour' (recommended) or '1 day'
      cache_duration_sec: 3600         # Cache SMAs for 1 hour  

    # Scanner Targets (Priority 2 - fill gaps between SMAs)
    scanner_targets:
      enabled: true
      use_target1: true               # Include scanner target1
      use_target2: true               # Include scanner target2
      use_target3: false              # Usually too far away

    # Progressive Stop Management
    progressive_stops:
      enabled: true
      move_to_previous_level: true    # Stop follows previous exit level
      min_stop_distance_pct: 0.005    # Keep 0.5% buffer below level

    # Fallback Settings
    fallback_to_1r: true              # Use 1R system if insufficient levels
    min_levels_required: 2            # Need at least 2 levels to use progressive

  # Trailing stop for runners (per requirements)
  trailing_stop:
    enabled: true             # Per requirements - let winners run with protection
    type: "percentage"        # "percentage" or "atr"
    percentage: 0.01          # Trail by 1% (changed from 0.01 - Oct 20, 2025)
    atr_multiplier: 2.0       # Trail by 2x ATR (for atr type)
    min_profit_to_activate: 0.0  # Activate immediately after partials taken (changed from 0.02 - Oct 20, 2025)

  # ===== DYNAMIC RESISTANCE EXITS (Oct 15, 2025) =====
  # NEW: Take partials when approaching technical resistance levels
  # Uses hourly SMAs, Bollinger Bands, and Linear Regression channels
  # Smarter than fixed 1% trailing - respects actual market structure
  # Example: SOFI $28.55 entry → detect SMA50 @ $28.85 → take 25% partial, trail remainder
  dynamic_resistance_exits:
    enabled: true                     # Enable dynamic resistance detection
    resistance_distance_pct: 0.005    # 0.5% = "near" resistance threshold
    min_gain_before_check: 0.005      # Only check after 0.5% profit minimum
    partial_size: 0.25                # Take 25% partial at resistance
    trailing_distance_pct: 0.005      # 0.5% trail distance after partial

    # Which technical levels to check
    check_smas: true                  # Check hourly SMAs (5, 10, 20, 50, 100)
    check_bollinger_bands: true       # Check Bollinger Bands upper band
    check_linear_regression: true     # Check Linear Regression upper channel

    # Bollinger Bands settings (hourly timeframe)
    bb_period: 20                     # 20-period SMA on hourly bars
    bb_std_dev: 2                     # 2 standard deviations

    # Linear Regression settings (hourly timeframe)
    lr_period: 30                     # 30-period lookback on hourly bars

    # SMA periods to check (hourly timeframe)
    sma_periods: [5, 10, 20, 50, 100]  # All hourly SMAs

  risk:
    breakeven_after_partial: true   # Move stop to breakeven after taking partial
    close_all_by_eod: true         # Flat by end of day
    stop_at_pivot: false           # Initial stop at pivot level (DISABLED - using ATR stops)
    use_atr_stops: true            # Use ATR-based stops (Oct 4, 2025)
    atr_stop_multiplier: 2.0       # Stop = Entry - (2.0 × ATR) for longs
    atr_stop_period: 20            # Calculate ATR from last 20 bars

    # 7-Minute Rule (PS60) - Exit if no progress after 7 minutes
    # Changed from 15 to 7 minutes per PS60 methodology (Oct 11, 2025)
    # Analysis showed 84% of losers hit 15-min rule, PS60 recommends 5-7 minutes
    fifteen_minute_rule_enabled: true    # Enable stuck position exit
    fifteen_minute_threshold: 7           # Exit after 7 minutes with no progress (per PS60)
    fifteen_minute_min_gain: 0.001       # Minimum 0.1% gain to avoid exit (must show some progress)

  # Trade confirmation (per requirements - avoid false breakouts)
  confirmation:
    enabled: true                   # Enable confirmation logic
    volume_surge_required: true     # Require volume surge
    volume_surge_multiplier: 1.2    # Volume must be 1.2x average (reduced from 2.0x - Oct 4, 2025)
    momentum_candle_required: true  # Require strong momentum candle
    momentum_candle_size: 1.5       # Candle must be 1.5x average range
    sustained_break_minutes: 2      # Must hold above pivot for N minutes (configurable)

    # STRICT PULLBACK/RETEST STRATEGY (Oct 19, 2025) ⭐ NEW
    # ALL breakouts require pullback/retest confirmation
    # NO immediate momentum entries - always wait for pullback
    # CVD + volume filters must pass during retest

    # Always require 1-min candle close (filters most whipsaws)
    require_candle_close: true      # Wait for 1-min candle to close above resistance
    candle_timeframe_seconds: 60    # 60 seconds = 1-minute candles

    # MINIMUM VOLUME THRESHOLD (Oct 20, 2025 - CRITICAL FIX)
    # Applies to ALL entry paths (MOMENTUM, PULLBACK, SUSTAINED_BREAK)
    # Rejects breakouts with sub-average volume at initial breakout detection
    # IMPACT: Would have prevented 6/10 Oct 15 trades (0.44x-0.79x volume)
    min_initial_volume_threshold: 1.0       # Minimum 1.0x average volume required (blocks <1.0x breakouts)

    # MOMENTUM BREAKOUT thresholds (Oct 20, 2025 - Increased to 3.0x)
    # Requires strong initial volume AND sustained volume on next candle
    momentum_volume_threshold: 3.0          # Volume must be 3.0x average for MOMENTUM entry
    momentum_candle_min_pct: 0.003          # Candle must be 0.3% for MOMENTUM entry
    momentum_candle_min_atr: 2.0            # Candle must be 2.0x ATR for MOMENTUM entry

    # Sustained volume requirement (Oct 20, 2025 - NEW)
    # After initial momentum candle (3.0x), subsequent candles must also have elevated volume
    sustained_volume_threshold: 1.5         # Subsequent candles must have 1.5x volume to confirm momentum
    sustained_volume_candles: 2             # Number of subsequent candles to check (1 = check next candle only, 2 = check next 2 candles)

    # RSI/MACD Momentum Filters (Oct 7, 2025) - DISABLED (ineffective for intraday)
    enable_rsi_filter: false                # ❌ DISABLED - 1-hour too slow for intraday breakouts
    rsi_period: 14                          # RSI calculation period
    rsi_threshold: 60                       # Minimum RSI (50=bias, 60=strong)
    rsi_timeframe: '1 hour'                 # 1 hour bars (more reliable than 5-min)

    enable_macd_filter: false               # ❌ DISABLED - 1-hour too slow for intraday breakouts
    macd_fast: 12                           # MACD fast EMA (hourly standard)
    macd_slow: 26                           # MACD slow EMA (hourly standard)
    macd_signal: 9                          # MACD signal EMA (hourly standard)
    macd_timeframe: '1 hour'                # 1 hour bars (same as RSI)

    # PULLBACK/RETEST thresholds (MANDATORY for ALL entries - Oct 19, 2025)
    # ALL breakouts must pullback and retest with strong confirmation
    # CVD + volume filters checked during retest (not initial break)
    require_pullback_retest: true           # ✅ MANDATORY - all entries require pullback
    pullback_distance_pct: 0.005            # Must pullback within 0.5% of pivot (changed from 0.3% - Oct 20, 2025)
    max_pullback_bars: 24                   # Max 2 minutes (24 × 5-sec bars) to retest
    pullback_volume_threshold: 2.0          # ✅ Strong volume required on retest (2.0x)
    pullback_candle_min_pct: 0.005          # ✅ Minimum 0.5% candle size on retest
    max_retest_time_minutes: 30             # ✅ Only allow retests within 30 min of initial break

    # SUSTAINED BREAK logic (DISABLED - Oct 19, 2025)
    # Too aggressive without pullback confirmation
    sustained_break_enabled: false          # ❌ DISABLED - only use pullback/retest strategy
    sustained_break_minutes: 1              # Not used when disabled
    sustained_break_max_pullback_pct: 0.003 # Not used when disabled

    # ENTRY QUALITY FILTERS (Applied during entry decision)
    # --------------------------------------------------------------------------

    # RANGE-BASED CHASING FILTER (Oct 4, 2025) - For MOMENTUM entries only
    # Purpose: Prevent entering momentum breakouts when already at top of range
    # When: Checked for MOMENTUM entries ONLY (not pullback/sustained)
    # How: Measures entry position as % of recent 5-minute range
    # Impact: Winners entered at 36% of range, losers at 81%
    # Note: Pullback/sustained use room-to-run filter instead
    enable_entry_position_filter: false     # DISABLED - superseded by room-to-run filter
    max_entry_position_pct: 70              # Don't enter above 70% of 5-min range
    entry_position_lookback_bars: 60        # 5 minutes (60 × 5-sec bars)

    # CHOPPY MARKET FILTER (Oct 4, 2025) ⭐ CRITICAL
    # Purpose: Avoid entering during consolidation/sideways markets (high whipsaw risk)
    # When: Checked for ALL entry types (momentum, pullback, sustained)
    # How: Compares recent 5-min range to ATR (volatility measure)
    # Impact: 61% of losses came from choppy conditions, lost $15,425 in one week
    # Logic: If range < 0.5× ATR → CHOPPY (block), else TRENDING (allow)
    # Documentation: See FILTER_DOCUMENTATION.md "Choppy Market Filter"
    enable_choppy_filter: true              # ENABLED - prevents consolidation entries
    choppy_atr_multiplier: 0.5              # Recent range must be >0.5× ATR
    choppy_lookback_bars: 60                # 5 minutes (60 × 5-sec bars)

  # Setup types to trade
  setup_types:
    breakout: true                  # Trade breakout entries
    bounce: false                   # DISABLED (Oct 5, 2025): 98.7% failure rate, requires human discretion per PS60
    rejection: false                # Trade rejection/fade setups (shorts on failed breakouts)

  # Direction filter
  enable_shorts: true               # ENABLED - Using same two-scenario stop logic
  enable_longs: true                # ENABLED

  attempts:
    max_attempts_per_pivot: 2  # Max 2 tries per pivot (backtest optimal)

filters:
  # ============================================================================
  # FILTER CONFIGURATION MATRIX (Oct 6, 2025 - Enhanced Scoring Update)
  # ============================================================================
  # Each filter can be independently enabled/disabled for testing and tuning.
  # Filters are applied in order during entry decision process.
  # See FILTER_DOCUMENTATION.md for detailed explanation of each filter.
  # ============================================================================

  # SCANNER-BASED FILTERS (Pre-entry screening)
  # ----------------------------------------------------------------------------
  # LEGACY FILTERS (Used when enhanced scoring CSV not available)
  min_score: 0                 # Minimum scanner score (0-100, 0 = disabled)
  min_risk_reward: 0.0         # DISABLED - Calculate R/R dynamically at entry time instead (Oct 13, 2025)
  max_dist_to_pivot: 100.0     # Max distance to pivot % (100 = disabled)

  # ENHANCED SCORING FILTERS (Oct 6, 2025) ⭐ NEW
  # ----------------------------------------------------------------------------
  # Based on validation showing 70% accuracy in top 10 ranked setups
  # These filters apply when using enhanced scoring CSV (rescored_YYYYMMDD.csv)

  # Enhanced score thresholds
  min_enhanced_score: 85       # Minimum enhanced score (0-100+)
                               # 85+ captures top-tier setups
                               # TIER 1 stocks typically score 100
                               # TIER 2 stocks typically score 85-100

  # Pivot width filter (KEY INSIGHT: tight pivots = winners)
  # Winners averaged 2.51% pivot width vs 4.92% for false breakouts
  min_pivot_width_pct: 0.0     # Minimum pivot width % (0 = no min)
  max_pivot_width_pct: 5.0     # Maximum pivot width %
                               # 5.0% = avoid very wide pivots (high false breakout risk)
                               # Per validation: >5% = likely false breakout

  # Test count filter (KEY INSIGHT: heavily tested = higher success)
  # Tested ≥10x = 80% success rate, <5x = 47% success rate
  min_test_count: 5            # Minimum number of times resistance/support tested
                               # 5+ = 58% success rate
                               # 10+ = 80% success rate (TIER 1)

  # Tier-based filtering
  tier_filter:                 # Which tiers to trade
    - 'TIER 1'                 # Always trade (70-80% expected success)
    - 'TIER 2'                 # Trade with normal position size (50-60% success)
    - 'TIER 3'                 # Trade selectively (40-50% success)
    # 'AVOID' tier is never traded (blacklisted or too wide pivots)

  # GAP FILTER (Overnight gap detection)
  # ----------------------------------------------------------------------------
  # Purpose: Skip trades where overnight gaps ate up the move
  # When: Checked at market open before monitoring begins
  # Impact: Prevents entering setups with insufficient room after gaps
  # Documentation: See CLAUDE.md "Gap Handling" section
  enable_gap_filter: false     # DISABLED for testing
  max_gap_through_pivot: 1.0   # Max 1% gap through pivot (small gap OK)
  min_room_to_target: 3.0      # Min 3% room to target after gap

  # ROOM-TO-RUN FILTER (Oct 5, 2025) ⭐ NEW
  # ----------------------------------------------------------------------------
  # Purpose: Ensure sufficient room to target at entry time
  # When: Checked for pullback/retest and sustained break entries ONLY
  #       NOT checked for momentum entries (immediate entries don't need this)
  # How: Calculates (target - entry_price) / entry_price as percentage
  # Impact: Blocks marginal setups where confirmation delay ate the move
  # Example: PLTR Oct 1 had 0.61% room vs 1.5% minimum → BLOCKED
  # Documentation: See FILTER_DOCUMENTATION.md "Room-to-Run Filter"
  enable_room_to_run_filter: true
  min_room_to_target_pct: 1.5  # Require 1.5% minimum room to target
                               # Entry $183, Target $184.14 = 0.6% → BLOCK
                               # Entry $100, Target $103 = 3.0% → ALLOW

  # ENTRY POSITION FILTER (Oct 15, 2025) ⭐ NEW
  # ----------------------------------------------------------------------------
  # Purpose: Prevent entering too far above resistance (chasing stale retests)
  # When: Checked for ALL entry types during pullback/retest confirmation
  # How: Blocks if entry_price > pivot_price * (1 + max_entry_above_resistance)
  # Impact: Prevents chasing stocks that already moved away from breakout
  # Example: GM resistance $57.45, entry $57.79 (+0.59%) → BLOCKED if max=0.003
  max_entry_above_resistance: 0.003  # ✅ NEW: Don't enter >0.3% above pivot for LONGS
  max_entry_below_support: 0.003     # ✅ NEW: Don't enter >0.3% below pivot for SHORTS

  # SYMBOL FILTERS (Blacklist/Whitelist)
  # ----------------------------------------------------------------------------
  # Purpose: Avoid specific symbols or categories with poor characteristics
  # When: Checked during watchlist filtering
  # Impact: Completely removes symbols from consideration
  avoid_index_shorts: true     # Skip SPY/QQQ/DIA shorts (saved $700/day in backtest)
  avoid_symbols:               # Complete blacklist
    - "SPY"    # Index ETFs - too choppy, whipsaw frequently
    - "QQQ"
    - "DIA"
    - "IWM"

# STOCHASTIC OSCILLATOR FILTER (Oct 15, 2025) ⭐ NEW
# ----------------------------------------------------------------------------
# Purpose: Confirm momentum and avoid overbought/oversold entries
# Uses: Hourly bars with 21-period lookback (Stochastic 21, 1, 3)
# LONG entries: %K must be between 60-80 (momentum zone, not overbought)
# SHORT entries: %K must be between 20-50 (momentum zone, not oversold)
# Applied to: ALL entry paths (momentum, pullback, sustained)
# Documentation: See explained/STOCHASTIC_21_1_3_EXPLAINED.md
stochastic:
  enabled: true                     # Enable stochastic confirmation filter
  k_period: 21                      # Lookback period (21 hourly bars = ~2.5 days)
  k_smooth: 1                       # %K smoothing (1 = no smoothing, raw stochastic)
  d_smooth: 3                       # %D smoothing (3-period SMA of %K)

  # Entry requirements by direction
  long_min_k: 60                    # LONG: %K must be ≥60 (has momentum)
  long_max_k: 80                    # LONG: %K must be ≤80 (not overbought)

  short_min_k: 20                   # SHORT: %K must be ≥20 (not oversold)
  short_max_k: 50                   # SHORT: %K must be ≤50 (has downward momentum)

  cache_duration_sec: 3600          # Cache stochastic values for 1 hour
  allow_entry_if_unavailable: true  # If stochastic can't be calculated, allow entry anyway

# CVD (CUMULATIVE VOLUME DELTA) FILTER (Oct 19, 2025) ⭐ NEW
# ----------------------------------------------------------------------------
# Purpose: Validate breakout quality by measuring buying vs selling pressure
# Uses: Bar approximation (backtesting) or tick data (live trading)
# LONG entries: CVD trend must be BULLISH (positive slope = net buying)
# SHORT entries: CVD trend must be BEARISH (negative slope = net selling)
# Applied to: ALL entry paths (momentum, pullback, sustained)
# Impact: Oct 16 test showed 71.4% block rate on weak entries
#
# How CVD works:
# - Measures cumulative difference between buying volume and selling volume
# - Bar approximation: Close in upper half of range = buying, lower half = selling
# - Tick data (live): Upticks = buying, downticks = selling
# - Slope calculation: Linear regression over last N bars
# - Trend classification: Slope > +1000 = BULLISH, < -1000 = BEARISH
#
# Why it's effective:
# - Detects when breakouts lack real buying/selling pressure
# - Oct 16 example: META SHORT had BULLISH CVD (buyers absorbing sellers) → BLOCKED
# - Prevents counter-trend entries (e.g., shorting into buying pressure)
#
# Configuration:
confirmation:
  cvd:
    enabled: true                    # ✅ ENABLED for Oct 16 backtest validation

    # Calculation settings
    slope_lookback: 5                # Number of bars for slope calculation
                                     # 5 bars = ~5 minutes of data for trend detection

    # Trend thresholds
    bullish_slope_threshold: 1000    # Minimum slope for BULLISH trend
                                     # If slope > +1000 → net buying pressure
    bearish_slope_threshold: -1000   # Maximum slope for BEARISH trend
                                     # If slope < -1000 → net selling pressure
                                     # Between thresholds → NEUTRAL (allowed)

    # Divergence settings (warning only, doesn't block)
    detect_divergence: true          # Warn on price/CVD divergence
    block_on_divergence: false       # Don't block entries on divergence (just warn)
                                     # Bullish div: Price down, CVD up (reversal signal)
                                     # Bearish div: Price up, CVD down (reversal signal)

    # Data source priorities
    prefer_tick_data: true           # Use tick data when available (live trading)
    bar_approximation_enabled: true  # Fall back to bar approximation (backtesting)

    # Caching (for live trading performance)
    cache_duration_sec: 60           # Cache CVD calculations for 1 minute

ibkr:
  host: "127.0.0.1"
  port: 7497                   # Paper trading port (7496 for live)
  client_id: 2010              # Changed from 2003 (Oct 16, 2025) - Fix applied

scanner:
  output_dir: "../stockscanner/output/"
  results_file: "scanner_results_20251002.json"
  enhanced_scoring_dir: "../scanner_validation_DISABLED/"  # DISABLED - Use regular scanner output (min_score=0)

logging:
  log_dir: "./logs/"
  log_level: "INFO"          # DEBUG, INFO, WARNING, ERROR (changed to INFO for faster backtest - Oct 13, 2025)
  log_trades: true
  log_positions: true
  save_daily_report: true

notifications:
  enabled: false              # Email/SMS notifications
  on_trade: false
  on_daily_close: true
  on_error: true

# Development/Testing
paper_trading: true          # MUST be true for initial testing
dry_run: false               # Set to true to monitor without trading
